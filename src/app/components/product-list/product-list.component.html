<div class="row products-box">
  <div class="col-12 px-0 mb-4 sticker" [class.authorised]="(isAuthorised$ | async)">
    <div>
      <div class="px-3">
        <div #stickerContent class="stickerContent">
          <form [formGroup]="queryForm" class="position-relative">
          <ul class="d-flex px-0 mb-3 align-items-center" style="overflow-x: scroll;">
            @for (cat of (categories$ | async); track cat) {
              <li class="me-2 mb-2">
                <a class="btn-pink px-4 py-2 fw-semibold d-flex justify-content-between align-items-center"
                  [class.active]="(activeCategory | async) === cat.id"
                  (click)="setActiveCategory(cat.id)">
                  {{ cat.abbreviation }}
                  <span class="ms-2">{{ cat.total_games }}</span>
                </a>
              </li>
            }

            <li class="nav-item mb-2 px-3">
              <div class="form-check form-switch d-flex align-items-center text-light">
                <input class="form-check-input" type="checkbox" id="onlyDigitalSwitch"
                  formControlName="skipDigitalFilter"
                />
                <label class="form-check-label ms-2 small" for="onlyDigitalSwitch">
                  Пропустить цифровые
                </label>
              </div>
            </li>

            <li [formGroup]="queryForm" class="nav-item mb-2 pl-3" style="margin-left: auto;">
              <select 
                  class="form-select form-select-lg border-0 rounded-3"
                  formControlName="sort">
                  <option value="name">По названию</option>
                  <option value="date">По дате</option>
                  <option value="popularity">По популярности</option>
              </select>
            </li>
          </ul>
          
            <div class="row">
              <div class="col">
                <input id="query"
                  #query
                  class="border-0 rounded-3 w-100"
                  type="text"
                  placeholder="Название"
                  autocomplete="off"
                  formControlName="query" />
              </div>
              <div class="col-auto d-none d-md-block">
                <select 
                  class="form-select form-select-lg border-0 rounded-3"
                  formControlName="franschise">
                  <option value="null">Франшиза</option>
                  <option value="1">metal gear solid</option>
                  <option value="2">silent hill</option>
                </select>
              </div>
              <div class="col-auto d-none d-md-block">
                <select 
                  class="form-select form-select-lg border-0 rounded-3"
                  formControlName="developer">
                  <option value="null">Разработчик</option>
                  <option value="1">Konami</option>
                  <option value="2">other</option>
                </select>
              </div>
              <div class="col-auto d-none d-md-block">
                <select 
                  class="form-select form-select-lg border-0 rounded-3"
                  formControlName="publisher">
                  <option value="null">Издатель</option>
                  <option value="1">Konami</option>
                  <option value="2">other</option>
                </select>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Продукты -->
  
  @for (product of products$ | async; track product.id) {
    <!-- Desktop / tablet: карточки -->
    <div class="col-xl-3 col-lg-4 col-md-4 col-sm-6 p-3">
      <div
        class="card game-card border-0 d-flex flex-column justify-content-between position-relative"
        [routerLink]="[product.id.toString(), {platform: activeCategory.value}]"
        style="cursor: pointer;"
        >
        @if (product.owned) {
          <a class="position-absolute" style="top: 8px; left: 8px;">
            <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="28" height="28" rx="4" fill="#BDA7EA"/>
            <path d="M21.1564 8.07556C21.0572 7.9724 20.9391 7.89052 20.8091 7.83464C20.679 7.77877 20.5395 7.75 20.3986 7.75C20.2577 7.75 20.1182 7.77877 19.9881 7.83464C19.8581 7.89052 19.74 7.9724 19.6408 8.07556L11.6892 16.2861L8.34852 12.8302C8.2455 12.7276 8.12389 12.6469 7.99063 12.5927C7.85737 12.5386 7.71507 12.512 7.57185 12.5146C7.42864 12.5171 7.28732 12.5487 7.15595 12.6076C7.02459 12.6665 6.90575 12.7515 6.80624 12.8577C6.70672 12.9639 6.62847 13.0894 6.57596 13.2268C6.52344 13.3642 6.49769 13.5109 6.50016 13.6586C6.50264 13.8063 6.5333 13.952 6.5904 14.0875C6.64749 14.2229 6.7299 14.3455 6.83292 14.4481L10.9314 18.6744C11.0307 18.7776 11.1487 18.8595 11.2788 18.9154C11.4088 18.9712 11.5483 19 11.6892 19C11.8301 19 11.9696 18.9712 12.0997 18.9154C12.2298 18.8595 12.3478 18.7776 12.447 18.6744L21.1564 9.69346C21.2647 9.59039 21.3512 9.46531 21.4103 9.32608C21.4695 9.18685 21.5 9.0365 21.5 8.88451C21.5 8.73251 21.4695 8.58216 21.4103 8.44294C21.3512 8.30371 21.2647 8.17862 21.1564 8.07556Z" fill="#5B399D"/>
            </svg>
          </a>
        }
        <div
          class="d-flex align-items-center justify-content-center"
          style="height: 214px; overflow: hidden;"
          >
          @if (product.image_url) {
            <img
              [src]="product.image_url"
              [alt]="product.name"
              class="img-fluid"
              style="max-height: 100%; object-fit: cover;"
              (error)="product.image_url = null"
              />
          } @else {
            <div class="d-flex flex-column align-items-center">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor"
                class="bi bi-image" viewBox="0 0 16 16">
                <path d="M14.002 3a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H2.002a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h12zM2.002 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2.002z"/>
                <path d="M10.648 8.646a.5.5 0 0 1 .704 0l2.25 2.25V12H2.398v-.316l3.85-3.85a.5.5 0 0 1 .704 0l2.15 2.15 1.546-1.548z"/>
              </svg>
              <small class="mt-1">Нет изображения</small>
            </div>
          }
        </div>
        <div class="d-flex flex-column justify-content-between">
          <div class="game-content">
            <div class="title">{{ product.name }}</div>
            <div class="game-first-release text-lite-muted small">
              @if (product.first_release_date) {
                c {{ product.first_release_date | date: 'dd.MM.yy' : 'UTC' }}
              } @else {
                никогда не была выпущена
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  }
  


  <div class="col-12 py-0">
    <app-pager
      (pageChange)="pageChanged($event)"
      [limit]="limit"
      [offset]="(offset$ | async) || 0"
      [totalCount]="(productsTotalCount$ | async) || 0"
      >
    </app-pager>
  </div>
</div>
