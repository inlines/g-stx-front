<div class="row">
  <div class="col-12 px-0 mb-4 sticker authorised">
    @if (!!(collection$ | async)?.length) {
      <div>
        <div>
          <div #stickerContent class="stickerContent">
            <form [formGroup]="queryForm" class="position-relative">
            <ul class="nav nav-pills flex-wrap justify-content-start mb-3">
              @for (cat of (displayCategories$ | async); track cat) {
                <li class="me-2 mb-2"
                  >
                  <a class="btn-pink px-4 py-2 fw-semibold d-flex justify-content-between align-items-center"
                    [class.active]="activeCategory === cat.id"
                    (click)="setActiveCategory(cat.id, cat.user_games, cat.total_spent)">
                    <span>
                      {{ cat.abbreviation }}
                    </span>
                    <span>
                      {{ cat.user_games }}/{{ cat.total_games }}
                    </span>
                  </a>
                </li>
                <li [formGroup]="queryForm" class="nav-item mb-2 pl-3" style="margin-left: auto;">
                  <div ngbDropdown class="d-inline-block">
                    <button
                      class="btn-pink active dropdown-toggle"
                      ngbDropdownToggle
                      type="button">
                      {{ sortBy$.value === 'name' ? 'По имени' : sortBy$.value === 'date' ? 'По дате' : 'По цене' }}
                    </button>
                    <div ngbDropdownMenu class="dropdown-menu dropdown-menu-dark">
                      <button ngbDropdownItem (click)="setSort('name')">По имени (A-Z)</button>
                      <button ngbDropdownItem (click)="setSort('date')">По дате релиза</button>
                      <button ngbDropdownItem (click)="setSort('price')">По цене</button>
                    </div>
                  </div>
                </li>
              }
            </ul>
            <div class="row">
              <div class="col">
                <input id="query"
                  #query
                  class="form-control form-control-lg border-0 rounded-3 pe-5"
                  type="text"
                  placeholder="Название"
                  formControlName="query"
                  autocomplete="off"/>
              </div>
            </div>
            </form>
          </div>

          
            
          
        </div>

      </div>
    }
  </div>
  @if (!!(collection$ | async)?.length) {
    @for (product of collectionWithLetters$ | async; track product.item.release_id) {
      <!-- Desktop / tablet: карточки -->
      <div class="col-12 p-3" style="color: rgba(211, 225, 236, 1);">
        <div
          class="game-card position-relative row"
          [routerLink]="['/products/' + product.item.product_id.toString(), {platform: activeCategory}]"
          style="cursor: pointer;"
          (click)="null"
          >
          <div
            class="col-auto px-0"
            style="height: 92px; overflow: hidden;"
            >
            @if (product.item.image_url) {
              <img
                [src]="product.item.image_url"
                [alt]="product.item.product_name"
                class="img-fluid"
                style="max-height: 100%; object-fit: cover;"
                (error)="product.item.image_url = null"
                />
            } @else {
              <div class="text-muted d-flex flex-column align-items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="92" height="92" fill="currentColor"
                  class="bi bi-image" viewBox="0 0 16 16">
                  <path d="M14.002 3a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H2.002a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h12zM2.002 2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H2.002z"/>
                  <path d="M10.648 8.646a.5.5 0 0 1 .704 0l2.25 2.25V12H2.398v-.316l3.85-3.85a.5.5 0 0 1 .704 0l2.15 2.15 1.546-1.548z"/>
                </svg>
                <small class="mt-1">Нет изображения</small>
              </div>
            }
          </div>
          <div class="col-7 d-flex flex-column justify-content-between" style="padding-top:20px; padding-left: 20px; padding-right: 20px; padding-bottom: 16px;">
            <h6 class="card-title text-truncate">{{ product.item.product_name }}</h6>
            <div class="card-subtitle">
              <span class="release-bullet">
                {{ product.item.release_date || 0 * 1000 | date:'dd.MM.yy':'UTC' }}
              </span>
              <span class="release-bullet">
                {{ product.item.platform_name }}
              </span>
              <span class="release-bullet">
                {{ product.item.region_name }}
              </span>
              <span class="release-bullet">
                {{ product.item.serial?.join(' | ') }}
              </span>
            </div>
          </div>

          <div class="col-2 text-end d-flex flex-column justify-content-center">
            @if (product.item.price) {
              {{ product.item.price | currency:'₽':'symbol':'1.0-2' }}
            } @else {
              ₽?
            }
          </div>
          <div class="col-auto d-flex flex-column justify-content-center">
              <button
                type="button"
                class="btn-blue"
                (click)="setPrice(product.item.release_id, product.item.product_name, $event); $event.stopPropagation()"
              >
              задать цену
            </button>
          </div>
          <div class="col-auto d-flex flex-column justify-content-center">
            <a
              type="button"
              (click)="remove(product.item.release_id, $event); $event.stopPropagation();"
              >
              <svg width="44" height="38" viewBox="0 0 44 38" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="0.5" y="0.5" width="43" height="37" rx="7.5" stroke="#2D587E"/>
                <path d="M19.0833 14.4286V12.4286C19.0833 12.0497 19.237 11.6863 19.5105 11.4184C19.784 11.1505 20.1549 11 20.5417 11H23.4583C23.8451 11 24.216 11.1505 24.4895 11.4184C24.763 11.6863 24.9167 12.0497 24.9167 12.4286V14.4286M15 14.4286H29M27.8333 14.4286V25.4286C27.8333 25.8453 27.6643 26.245 27.3635 26.5397C27.0626 26.8344 26.6546 27 26.2292 27H17.7708C17.3454 27 16.9374 26.8344 16.6365 26.5397C16.3357 26.245 16.1667 25.8453 16.1667 25.4286V14.4286H27.8333Z" stroke="#8AACC9" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </a>
          </div>
        </div>
      </div>
      <!-- Mobile: горизонтальная карточка -->
       <!-- <div class="col-12 d-block d-md-none mb-3 overflow-hidden">
        <div
          class="game-card h-100 border-0 shadow-sm hover-shadow position-relative row"
          [routerLink]="['/products/' + product.item.product_id.toString(), {platform: activeCategory}]"
          style="cursor: pointer;"
          (click)="null"
          >
          <h5 class="col-2 d-flex flex-column justify-content-center">
            @if (sortBy$.value === 'name' ) {
              <ng-container>
                {{ product.letter || '&nbsp;&nbsp;' }}
              </ng-container>
            }
            @if (sortBy$.value === 'date' ) {
              <ng-container>
                {{ product.release_year || '&nbsp;&nbsp;' }}
              </ng-container>
            }
          </h5>
          <h6 class="col-10 d-flex flex-column justify-content-center text-end">
            {{$index + 1}} / {{activeCategorCount}}
          </h6>
          <div class="col-8">
            <h6 class="card-title text-truncate fw-bold">{{ product.item.product_name }}({{ product.item.release_date || 0 * 1000 | date:'dd.MM.yy':'UTC' }})</h6>
            <div class="card-subtitle small mb-2">
              {{ product.item.platform_name }} [{{ product.item.region_name }}] ({{ product.item.serial?.join('|') }})
            </div>
          </div>
          <div class="col">
            @if (product.item.price) {
              {{ product.item.price | currency:'₽':'symbol':'1.0-2' }}
            } @else {
              ₽?
            }
          </div>
          <div class="col-auto py-2">
            <button
              type="button"
              class="btn btn-danger btn-sm w-100"
              (click)="setPrice(product.item.release_id, product.item.product_name, $event); $event.stopPropagation()"
            >
              задать цену
            </button>
          </div>
          <div class="col-auto py-2">
            <button
              type="button"
              class="btn btn-danger btn-sm w-100"
              (click)="remove(product.item.release_id, $event); $event.stopPropagation();"
              >
              удалить
            </button>
          </div>
        </div>
      </div> -->
    }
    <div class="text-white">На эту платформу вы потратили {{activeCategoryTotalSpent | currency:'₽':'symbol':'1.0-2' }}</div>
  } @else {
    <div class="text-white my-4">
      <div class="empty-collection-header mb-3">Ваша коллекция пока пуста</div>
      <p class="text-light mb-2">
        Начните собирать свою игровую библиотеку прямо сейчас! Зайдите в
        <a [routerLink]="'/products'" class="text-info text-decoration-none fw-semibold">
          каталог
        </a> — добавляйте игры, которые уже есть у вас, формируйте личную коллекцию, отмечайте желаемое и следите за доступными предложениями.
      </p>
      <p class="text-light mb-2">
        Вы можете добавлять игры в <a class="text-info text-decoration-none fw-semibold" [routerLink]="'/wishlist'">вишлист</a>, чтобы не упустить возможность купить или обменять их, как только появятся подходящие варианты. Предложения постоянно обновляется — не упустите редкие издания и выгодные предложения!
      </p>
      <p class="text-light mb-4">
        GSTX — это не только коллекции, но и <strong>сообщество</strong>: вы можете находить игроков с похожими интересами, предлагать обмены и делать свою игровую библиотеку живой. Пусть каждая игра найдет нового владельца — начните с первой!
      </p>
      <div>
        <a [routerLink]="'/products'" class="btn btn-outline-info btn-lg fw-semibold">
          Перейти в каталог
        </a>
      </div>
    </div>
  }




  <div class="col-12 mt-4 p-0">
    <app-pager (pageChange)="pageChanged($event)" [limit]="limit" [totalCount]="(collectionTotalCount$ | async) || 0"></app-pager>
  </div>
</div>


<ng-template #priceModal let-modal>
  <div class="modal-dialog modal-lg modal-dialog-centered animate__animated animate__fadeIn">
    <div class="modal-content p-0 border-0 bg-transparent">
      <div class="bg-dark text-white rounded-4 shadow-lg overflow-hidden w-100">

        <div class="modal-header border-secondary">
          <h4 class="modal-title text-warning">Задайте цену</h4>
        </div>

        <div class="modal-body">
          <ul class="list-unstyled m-0">
              <li class="mb-3">
                <div class="d-flex align-items-center bg-secondary bg-opacity-10 p-3 rounded-3 border border-secondary">
                  <div>
                    <div class="fw-semibold fs-6">
                      {{ setPriceProductName }}
                    </div>
                    <div>
                      <input type="text" [formControl]="priceControl">
                    </div>
                    <div>
                      <button class="d-block" type="button" (click)="sendPrice()" class="mt-4 btn btn-outline-warning btn-sm">
                        ок
                      </button>
                    </div>
                  </div>
                </div>
              </li>
          </ul>
        </div>

        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-light" (click)="modal.close()">Закрыть</button>
        </div>
      </div>
    </div>
  </div>
</ng-template>